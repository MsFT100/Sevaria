{% extends "navigation/base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Checkout</h2>
    <form id="payment-form" method="POST">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="amount">Amount:</label>
            <input type="text" id="amount" name="amount" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="description">Description:</label>
            <input type="text" id="description" name="description" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" class="form-control">
        </div>

        <div class="form-group">
            <label for="phone_number">Phone:</label>
            <input type="text" id="phone_number" name="phone_number" class="form-control">
        </div>

        <div class="form-group">
            <label for="first_name">First Name:</label>
            <input type="text" id="first_name" name="first_name" class="form-control">
        </div>

        <div class="form-group">
            <label for="last_name">Last Name:</label>
            <input type="text" id="last_name" name="last_name" class="form-control">
        </div>

        <div class="form-group">
            <label for="country">Country Code:</label>
            <input type="text" id="country" name="country" class="form-control">
        </div>

        <input type="submit" value="Pay Now" class="btn btn-primary">
    </form>

    <div id="error-message" class="alert alert-danger mt-3 d-none"></div>
</div>

<script>
    document.querySelector('#payment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const formData = new FormData(this);
        const errorMessage = document.getElementById('error-message');

        fetch("{% url 'initiate_payment' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;  // Redirect to PesaPal payment page
            } else {
                errorMessage.textContent = 'Payment initiation failed: ' + data.error;
                errorMessage.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorMessage.textContent = 'An error occurred during payment initiation. Please try again.';
            errorMessage.classList.remove('d-none');
        });
    });
</script>
{% endblock %}
